/*
 * BH1750.c
 *
 *  Created on: 11 wrz 2015
 *      Author: Bartek
 */

#include <avr/io.h>
#include <util/delay.h>
#include "BH1750.h"
#include "I2C.h"

uint8_t state_;
uint8_t mode_;


void BH1750_PowerOn()
{
	_delay_us(5);
	//BH1750_DVI_PORT |= BH1750_Power_ON << BH1750_DVI_PIN;
	state_ = BH1750_Power_ON;


}

void BH1750_PowerDown()
{
	//BH1750_DVI_PORT &= ~(BH1750_Power_OFF << BH1750_DVI_PIN);
	state_ = BH1750_Power_OFF;
	TWI_Start();
	TWI_Write_SLA(BH1750_SLA);
	TWI_WriteByte(BH1750_Power_OFF);
	TWI_Stop();


}

void BH1750_Start(uint8_t mode)
{
	mode_ = mode;
	//void TWI_Init();
	TWI_Start();
	TWI_Write_SLA(BH1750_SLA);
	TWI_WriteByte(mode);
	TWI_Stop();

}


uint16_t BH1750_Read()
{
#if mode == 1
  Serial.print("Light level: ");
  Serial.println(level);
#endif
	uint16_t result = 0;
	uint16_t lux = 0;
	TWI_Start();
	TWI_Write_SLA(BH1750_SLA);
	result = TWI_ReadByte_ACK();
	result <<= 8;
	result |= TWI_ReadByte_NACK();
	TWI_Stop();

	if(mode_ == BH1750_CHR_MODE2 || mode_ == BH1750_OTHR_MODE2)
	{
		lux = (result >> 1) * 10 / 12;
		if((result & 0x01) == 1)
		{
			lux++;
		}
	}
	else
	{
		lux = result * 10 / 12;
	}

	return lux;
}

void BH1750_ResetDR()		//Goes to power of after use this function
{
	if(state_ == BH1750_Power_OFF) BH1750_PowerOn();

	TWI_Start();
	TWI_Write_SLA(BH1750_SLA);
	TWI_WriteByte(BH1750_RESET);
	TWI_Stop();

	BH1750_PowerOff();
}

